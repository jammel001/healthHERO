<script>
const chatWindow = document.getElementById('chatWindow');
const chatInput = document.getElementById('chatInput');
const sendBtn = document.getElementById('sendBtn');
const restartBtn = document.getElementById('restartBtn');
const simplePdfBtn = document.getElementById('simplePdf');

function appendMessage(role, text) {
  const div = document.createElement('div');
  div.className = 'msg ' + role;
  div.textContent = text;
  chatWindow.appendChild(div);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}

async function sendMessage(text) {
  appendMessage('user', text);

  try {
    const r = await fetch('/api/diagnose', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ symptoms: text }) // âœ… FIXED
    });

    const j = await r.json();

    if (j.error) {
      appendMessage('ai', j.error);
      return;
    }

    if (j.explanations) {
      appendMessage('ai', 'Symptom explanations:');
      j.explanations.forEach(e => appendMessage('ai', e));
    }

    const top = j.top_prediction;
    appendMessage(
      'ai',
      `Most likely condition: ${top.condition} (Probability: ${top.probability.toFixed(2)})`
    );

    appendMessage('ai', top.description || 'No description available.');

    if (j.confidence_warning) {
      appendMessage('ai', j.confidence_warning);
    }

    if (j.other_predictions?.length) {
      appendMessage('ai', 'Other possible conditions:');
      j.other_predictions.forEach(p => {
        appendMessage('ai', `${p.condition} (${p.probability.toFixed(2)})`);
      });
    }

  } catch (err) {
    appendMessage('ai', 'Server error. Please try again later.');
    console.error(err);
  }
}

sendBtn.addEventListener('click', () => {
  const v = chatInput.value.trim();
  if (!v) return;
  sendMessage(v);
  chatInput.value = '';
});

chatInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    sendBtn.click();
  }
});

restartBtn.addEventListener('click', () => {
  chatWindow.innerHTML = '';
});

simplePdfBtn.addEventListener('click', () => {
  window.location.href = '/download_pdf';
});
</script>
